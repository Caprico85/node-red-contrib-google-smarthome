<!--
 NodeRED Google SmartHome
 Copyright (C) 2021 Michael Jacobsen.

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<script type="text/x-red" data-template-name="googlesmarthome-client">
    <style>
        ol#node-config-input-googlesmarthome-emails-container .red-ui-typedInput-container {
            flex:1;
        }
    </style>

    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="googlesmarthome.label.name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]googlesmarthome.placeholder.name">
    </div>

    <div class="form-row">
        <label style="width:auto" for="node-config-input-enabledebug"><i class="fa fa-arrow-right"></i> <span data-i18n="googlesmarthome.label.enabledebug"></span></label>
        <input type="checkbox" checked id="node-config-input-enabledebug" style="display:inline-block; width:auto; vertical-align:top;">
    </div>

    <div class="form-row">
        <label for="node-config-input-default_lang"><i class="fa fa-tag"></i> <span data-i18n="googlesmarthome.label.default_lang"></span></label>
        <select id="node-config-input-default_lang" >
            <option value='da' data-i18n='googlesmarthome.label.da'></option>
            <option value='nl' data-i18n='googlesmarthome.label.nl'></option>
            <option value='en' data-i18n='googlesmarthome.label.en'></option>
            <option value='fr' data-i18n='googlesmarthome.label.fr'></option>
            <option value='de' data-i18n='googlesmarthome.label.de'></option>
            <option value='hi' data-i18n='googlesmarthome.label.hi'></option>
            <option value='id' data-i18n='googlesmarthome.label.id'></option>
            <option value='it' data-i18n='googlesmarthome.label.it'></option>
            <option value='ja' data-i18n='googlesmarthome.label.ja'></option>
            <option value='ko' data-i18n='googlesmarthome.label.ko'></option>
            <option value='no' data-i18n='googlesmarthome.label.no'></option>
            <option value='pt-BR' data-i18n='googlesmarthome.label.pt-BR'></option>
            <option value='es' data-i18n='googlesmarthome.label.es'></option>
            <option value='sv' data-i18n='googlesmarthome.label.sv'></option>
            <option value='th' data-i18n='googlesmarthome.label.th'></option>
        </select>
    </div>

    <fieldset>
        <legend>Local Authentication</legend>

        <div class="form-row">
            <label style="width:auto" for="node-config-input-usegooglelogin"><i class="fa fa-arrow-right"></i> <span data-i18n="googlesmarthome.label.usegooglelogin"></span></label>
            <input type="checkbox" id="node-config-input-usegooglelogin" style="display:inline-block; width:auto; vertical-align:top;">
        </div>

        <div class="form-row hidden" id="usegooglelogin" style="background: #fbfbfb">
            <div class="form-row">
                <label for="node-config-input-loginclientid"><i class="fa fa-user"></i> <span data-i18n="googlesmarthome.label.loginclientid"></span></label>
                <input type="text" id="node-config-input-loginclientid">
            </div>

            <div class="form-row">
                <div class="form-row" style="margin-bottom:0;">
                    <label><i class="fa fa-list"></i> <span data-i18n="googlesmarthome.label.emails"></span></label>
                </div>
                <div class="form-row node-config-input-googlesmarthome-emails-container-row">
                    <ol id="node-config-input-googlesmarthome-emails-container"></ol>
                </div>
            </div>
        </div>

        <div class="form-row" id="useloginpwd" style="background: #fbfbfb">
            <div class="form-row">
                <label for="node-config-input-username"><i class="fa fa-user"></i> <span data-i18n="googlesmarthome.label.username"></span></label>
                <input type="text" id="node-config-input-username">
            </div>

            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> <span data-i18n="googlesmarthome.label.password"></span></label>
                <input type="password" id="node-config-input-password">
            </div>
        </div>

        <div class="form-row">
            <label for="node-config-input-accesstokenduration"><i class="fa fa-globe"></i> <span data-i18n="googlesmarthome.label.accesstokenduration"></span></label>
            <input type="text" id="node-config-input-accesstokenduration" data-i18n="[placeholder]googlesmarthome.placeholder.accesstokenduration">
        </div>
    </fieldset>

    <fieldset>
        <legend>Actions on Google Project Settings</legend>

        <div class="form-row">
            <label for="node-config-input-clientid"><i class="fa fa-user"></i> <span data-i18n="googlesmarthome.label.clientid"></span></label>
            <input type="text" id="node-config-input-clientid">
        </div>

        <div class="form-row">
            <label for="node-config-input-clientsecret"><i class="fa fa-lock"></i> <span data-i18n="googlesmarthome.label.clientsecret"></span></label>
            <input type="password" id="node-config-input-clientsecret">
        </div>
    </fieldset>

    <fieldset>
        <legend>Google HomeGraph Settings</legend>

        <div class="form-row">
            <label for="node-config-input-jwtkey"><i class="fa fa-folder"></i> <span data-i18n="googlesmarthome.label.jwtkey"></span></label>
            <input type="text" id="node-config-input-jwtkey">
        </div>

        <div class="form-row">
            <label for="node-config-input-reportinterval"><i class="fa fa-globe"></i> <span data-i18n="googlesmarthome.label.reportinterval"></span></label>
            <input type="text" id="node-config-input-reportinterval" data-i18n="[placeholder]googlesmarthome.placeholder.reportinterval">
        </div>
    </fieldset>

    <fieldset>
        <legend>Web Server Settings</legend>

        <div class="form-row">
            <label for="node-config-input-port"><i class="fa fa-globe"></i> <span data-i18n="googlesmarthome.label.port"></span></label>
            <input type="text" id="node-config-input-port" data-i18n="[placeholder]googlesmarthome.placeholder.port">
        </div>

        <div class="form-row">
            <label for="node-config-input-httppath"><i class="fa fa-folder"></i> <span data-i18n="googlesmarthome.label.httppath"></span></label>
            <input type="text" id="node-config-input-httppath">
        </div>

        <div class="form-row hidden" id="connectioninfo" style="background: #fbfbfb">

            <div class="form-row">
                <label style="width:auto" for="node-config-input-usehttpnoderoot"><i class="fa fa-arrow-right"></i> <span data-i18n="googlesmarthome.label.usehttpnoderoot"></span></label>
                <input type="checkbox" id="node-config-input-usehttpnoderoot" style="display:inline-block; width:auto; vertical-align:top;">
            </div>
        
        
            <div class="form-row">
                <label style="width:auto" for="node-config-input-ssloffload"><i class="fa fa-arrow-right"></i> <span data-i18n="googlesmarthome.label.ssloffload"></span></label>
                <input type="checkbox" id="node-config-input-ssloffload" style="display:inline-block; width:auto; vertical-align:top;">
            </div>

            <div class="form-row hidden" id="ssloffloadkeys" style="background: #fbfbfb">

                <div class="form-row">
                    <label for="node-config-input-publickey"><i class="fa fa-folder"></i> <span data-i18n="googlesmarthome.label.publickey"></span></label>
                    <input type="text" id="node-config-input-publickey">
                </div>

                <div class="form-row">
                    <label for="node-config-input-privatekey"><i class="fa fa-folder"></i> <span data-i18n="googlesmarthome.label.privatekey"></span></label>
                    <input type="text" id="node-config-input-privatekey">
                </div>
            </div>
        </div>
    </fieldset>
</script>

<script type="text/x-red" data-help-name="googlesmarthome-client">
    <b>Local Authentication</b><br>
    <code>Use Google login</code>: If enabled, use the Google login authentication.<br>
    <code>Login Client ID</code>: If Google Login is enabled, the client id you gained from the *Google Sign-In* integration.<br>
    <code>Authorized emails</code>: If Google Login is enabled, The email addresses authorized to log in.<br>
    <code>Username</code> and <code>Password</code>: A username and password used when you link Google SmartHome to this node.<br>
    <code>Access Token Duration</code>: The authorization token duration (in minutes) used by Google SmartHome to identify itself to node-red SmartHome plugin. Defaults is 60 minutes.<br>
    <br>
    <b>Actions on Google Project Settings</b><br>
    <code>Client ID</code>: The client id you entered in the <b>Google on Actions</b> project.<br>
    <code>Client Secret</code>: The client secret you entered in the <b>Google on Actions</b> project.<br>
    <br>
    <b>Google HomeGraph Settings</b><br>
    <code>Jwt Key</code>: Full path to JWT key file.<br>
    <code>Report Interval (m)</code>: Time, in minutes, between report updates are sent to Google.<br>
    <br>
    <b>Web Server Settings</b><br>
    <code>Use http Node-RED root path</code>: If enabled, use the same http root path prefix configured for Node-RED, otherwise use /.<br>
    <code>Path</code>: Prefix for URLs provided by this module. Default fulfillment URL is https://example.com:3001/smarthome. With a
          path of "foo" this changes to https://example.com:3001/foo/smarthome. Same for URLs `/oauth` and `/token`.<br>
    <code>Port</code>: TCP port of your choosing for incoming connections from Google. Must match what you entered in the <b>Google on Actions</b> project.<br>
    <code>External SSL offload</code>: If enabled, SSL encryption is not used by the node and must be done elsewhere.
    <code>Public Key</code>: Full path to public key file, e.g. `fullchain.pem` from Let's Encrypt.<br>
    <code>Private Key</code>: Full path to private key file, e.g. `privkey.pem` from Let's Encrypt.<br>

    <h3>References</h3>
    <p><a href="https://www.npmjs.com/package/node-red-contrib-google-smarthome" target="_new">Node Information</a>.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('googlesmarthome-client', {
        category: 'config',
        defaults: {
            name: {
                value: ""
            },
            enabledebug: {
                value: false
            },
            default_lang: {
                value: "en", required: true,
            },
            usegooglelogin : {
                value: false
            },
            /*
            loginclientid: {
                value:"", required:false,
                validate: function(v) {
                    let usegoogleloginField = $("#node-config-input-usegooglelogin");
                    let usegooglelogin = usegoogleloginField.length > 0 ? usegoogleloginField.prop('checked') : this.usegooglelogin;
                    return usegooglelogin ? v.trim().length > 0 : true;
                }
            },
            emails: {
                value:[], required:false, 
                validate: function(v) {
                    let usegoogleloginField = $("#node-config-input-usegooglelogin");
                    let usegooglelogin = usegoogleloginField.length > 0 ? usegoogleloginField.prop('checked') : this.usegooglelogin;
                    return usegooglelogin ? v.trim().length > 0 : true;
                }
            },
            username: {
                value:"", required:false,
                validate: function(v) {
                    let usegoogleloginField = $("#node-config-input-usegooglelogin");
                    let usegooglelogin = usegoogleloginField.length > 0 ? usegoogleloginField.prop('checked') : this.usegooglelogin;
                    return !usegooglelogin ? v.trim().length > 0 : true;
                }
            },
            password: {
                value:"", required:false,
                validate: function(v) {
                    let usegoogleloginField = $("#node-config-input-usegooglelogin");
                    let usegooglelogin = usegoogleloginField.length > 0 ? usegoogleloginField.prop('checked') : this.usegooglelogin;
                    return !usegooglelogin ? v.trim().length > 0 : true;
                }
            },
            */
            usehttpnoderoot : {
                value: false
            },
            port: {
                value:3001, required:false, validate:RED.validators.number(true)
            },
            httppath: {
                value:"", required: false
            },
            ssloffload: {
                value: false
            },
            /*
            publickey: {
                value:"", required:false,
                validate: function(v) {
                    let ssloffloadField = $("#node-config-input-ssloffload");
                    let ssloffload = ssloffloadField.length > 0 ? ssloffloadField.prop('checked') : this.ssloffload;
                    let portField = $("#node-config-input-port");
                    let port = portField.length > 0 ? portField.val() : this.port;
                    port = isNaN(port) ? 0 : +port;
                    return ssloffload || port <= 0 ? true : v.trim().length > 0;
                }
            },
            privatekey: {
                value:"", required:false,
                validate: function(v) {
                    let ssloffloadField = $("#node-config-input-ssloffload");
                    let ssloffload = ssloffloadField.length > 0 ? ssloffloadField.prop('checked') : this.ssloffload;
                    let portField = $("#node-config-input-port");
                    let port = portField.length > 0 ? portField.val() : this.port;
                    port = isNaN(port) ? 0 : +port;
                    return ssloffload || port <= 0 ? true : v.trim().length > 0;
                }
            },
            jwtkey: {
                value:"", required:true
            },
            */
            accesstokenduration: {
                value:60, required:true, validate:RED.validators.number(true)
            },
            reportinterval: {
                value:60, required:true, validate:RED.validators.number(true)
            },
            /*
            clientid: {
                value:"", required:true
            },
            clientsecret: {
                value:"", required:true
            }
            */
        },

        credentials: {
            loginclientid: { type: "text" },
            emails: { type: "text" },
            username: { type: "text" },
            password: { type: "password" },
            publickey: { type: "text" },
            privatekey: { type: "text" },
            jwtkey: { type: "text" },
            clientid: { type: "text" },
            clientsecret: { type: "password" },
        },
        color:"#3FADB5",
        icon: "google-smarthome.png",
        label: function() {
            return this.name || "googlesmarthome-client";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            // emails
            $('#node-config-input-googlesmarthome-emails-container').css('min-height', '150px').css('min-width', '250px').editableList({
                addItem: function (container, i, opt) {
                    var emails = opt;
                    if (!emails.hasOwnProperty('name')) {
                        emails = { name: "" };
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    let fragment = document.createDocumentFragment();
                    var row1 = $('<div/>', { style: "display:flex;" }).appendTo(fragment);
                    var propertyName = $('<input/>', { class: "node-config-input-googlesmarthome-emails-property-name", type: "text", style: "width: 100%" })
                        .appendTo(row1);
                    propertyName.val(emails.name);

                    container[0].appendChild(fragment);
                },
                removable: true,
                sortable: true
            });
            let emails = this.credentials.emails;
            if (typeof emails === 'string') {
                emails = emails.split(";");
            }
            if (!emails) {
                emails = [];
            }
            for (var i = 0; i < emails.length; i++) {
                var email = emails[i];
                $("#node-config-input-googlesmarthome-emails-container").editableList('addItem', { name: email });
            }
            // Use Google login on / off
            let useGoogleLogin = function() {
                let usegooglelogin = $("#node-config-input-usegooglelogin").prop('checked');
                if (usegooglelogin == false) {
                    $("#usegooglelogin").hide();
                    $("#useloginpwd").show();
                } else {
                    $("#usegooglelogin").show();
                    $("#useloginpwd").hide();
                }
            };
            useGoogleLogin();
            $("#node-config-input-usegooglelogin").change(useGoogleLogin);

            // Use external SSL offload on / off
            let sslOffLoadKeys = function() {
                let ssloffload = $("#node-config-input-ssloffload").prop('checked');
                if (ssloffload == false) {
                    $("#ssloffloadkeys").show();
                } else {
                    $("#ssloffloadkeys").hide();
                }
            };
            sslOffLoadKeys();
            $("#node-config-input-ssloffload").change(sslOffLoadKeys);

            // Use same NODE-Red port
            let useNODERedPort = function() {
                let input_port = $('#node-config-input-port').val();
                input_port = isNaN(input_port) ? 0 : +input_port;
                if ((input_port <= 0)) { //  || (RED.settings.uiPort === node)) {
                    $('#connectioninfo').hide();
                } else {
                    $('#connectioninfo').show();
                }
            };
            useNODERedPort();
            $('#node-config-input-port').change(useNODERedPort);
        },
        oneditsave: function () {
            var node = this;
             // emails
             var emails = $("#node-config-input-googlesmarthome-emails-container").editableList('items');
            node.credentials.emails = [];
            emails.each(function (i) {
                var email = $(this);
                var name = email.find(".node-config-input-googlesmarthome-emails-property-name").val();
                node.credentials.emails.push(name);
            });
        },
        oneditresize: function (size) {
            // emails
            var rows = $("#dialog-form>div:not(node-config-input-googlesmarthome-emails-container-row)");
            var height = size.height;
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-config-input-googlesmarthome-emails-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
            height += 16;
            $("#node-config-input-googlesmarthome-emails-container").editableList('height', height);
        }
    });
</script>

<!--
    Management Interface
-->
<script type="text/x-red" data-template-name="google-mgmt">
    <div class="form-row">
        <b>Google SmartHome Settings</b>
    </div>

    <div class="form-row">
        <label for="node-input-client"><i class="fa fa-globe"></i> SmartHome</span></label>
        <input type="text" id="node-input-client">
    </div>

    <div class="form-row">
        <b>Node-RED Settings</b>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="googlesmarthome.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]lgooglesmarthome.placeholder.name">
    </div>
</script>

<script type="text/x-red" data-help-name="google-mgmt">
    <p>Allows to manage the Google Smart Home service.</p>

    <h3>Inputs</h3>
        <dl class="message-properties">
            <dt>topic
                <span class="property-type">string</span>
            </dt>
            <dd>Command to run. Can be restart_server, report_state, request_sync, get_state or set_state.</dd>
        </dl>

     <h3>Output</h3>
        <dl class="message-properties">
            <dt>payload
                <span class="property-type">object</span>
            </dt>
            <dd>Debug messages from Google Smart Home service or the state of all Google Devices (with set_state or get_state topic).</dd>
        </dl>

    <h3>Details</h3>
        <h4>Node Properties - Google SmartHome Settings</h4>
        <p><code>SmartHome</code> Configuration node.</p>
        <h4>Node Properties - Node-RED Settings</h4>
        <p><code>Name</code> Name used by Google Smart Home.</p>

        <h4>Input Messages</h4>
        <p>If <code>msg.topic</code> is <code>restart_server</code> the built-in webserver will be restarted. Can be used when your SSL certificate has been renewed and needs to be re-read by the webserver.</p>
        <dl class="message-properties">
            <dt>topic
                <span class="property-type">string</span>
            </dt>
            <dd>A topic of <code>restart_server</code> restarts the built-in webserver. <code>msg.payload</code> is not used for anything.</dd>
        </dl>

        <p>If <code>msg.topic</code> is <code>report_state</code> an update of all device states will be sent to Google. Mostly useful for debugging.</p>
        <dl class="message-properties">
            <dt>topic
                <span class="property-type">string</span>
            </dt>
            <dd>A topic of <code>report_state</code> will send an update of all states to Google. <code>msg.payload</code> is not used for anything.</dd>
        </dl>

        <p>If <code>msg.topic</code> is <code>request_sync</code> Google is requested to sync to learn about new or changed devices. This usually happens automatically.</p>
        <dl class="message-properties">
            <dt>topic
                <span class="property-type">string</span>
            </dt>
            <dd>A topic of <code>request_sync</code> requests Google to sync to learn about new or changed devices. <code>msg.payload</code> is not used for anything.</dd>
        </dl>

        <p>If <code>msg.topic</code> is <code>get_state</code> the node send a message in output with all the Google device state.</p>
        <dl class="message-properties">
            <dt>topic
                <span class="property-type">string</span>
            </dt>
            <dd>A topic of <code>get_state</code> requests to send to the output the state of all Google devices. <code>msg.payload</code> is not used for anything.</dd>
        </dl>

        <p>If <code>msg.topic</code> is <code>set_state</code> the node updates the Google devices states with the states contained on the <code>msg.payload</code>.</p>
        <dl class="message-properties">
            <dt>topic
                <span class="property-type">string</span>
            </dt>
            <dd>A topic of <code>set_state</code> updates the Google devices states with the value of the <code>msg.payload</code>.</dd>
        </dl>

        <h4>Output Messages</h4>
        <p>This node will output debug messages if something goes wrong or the state of all Google Devices (with set_state or get_state topic).</p>
        <dl class="message-properties">
            <dt>payload
                <span class="property-type">string|object</span>
            </dt>
            <dd>This node will output debug messages if something goes wrong or the state of all Google Devices (with set_state or get_state topic).</dd>
        </dl>

        <p>If a device state changes, the node output a message with the <code>msg.topic</code> set to <code>set_state</code>, and the <code>msg.payload</code> contains all the Google devices states that can be persisted if needed. This message can be passed into the node to restore the persisted state.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('google-mgmt', {
        category: 'Google_SmartHome-function',
        paletteLabel: 'Management',
        defaults: {
            client: {
                type: "googlesmarthome-client", 
                required: true
            },
            name: {
                value: ""
            },
        },
        inputs: 1,
        outputs: 1,
        color:"#C0DEED",
        icon: "google-smarthome.png",
        label: function() {
            return this.name || "Management";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : ""
        }
    })
</script>

